<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>도트 횡스크롤 게임</title>
    <style>
        body { margin: 0; overflow: hidden; position: relative; }
        canvas { 
            background: #87CEEB; /* 하늘색 배경 */
            display: block; 
            width: 800px;
            height: 400px;
        }
        #gameOverScreen {
            display: none; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 800px; 
            height: 400px; 
            background-color: rgba(0, 0, 0, 0.7); 
            text-align: center; 
            color: white;
            padding-top: 150px;
            box-sizing: border-box;
        }
        #playAgainButton {
            padding: 10px 20px;
            font-size: 18px;
            margin-top: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <div id="gameOverScreen">
        <h1 id="gameOverMessage"></h1>
        <button id="playAgainButton">다시 하기</button>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // 땅 설정
        const groundHeight = 50;

        // 게임 상태 변수
        let gameOver = false;

        // 플레이어 설정
        const player = {
            x: 700,
            y: canvas.height - groundHeight - 64,
            width: 64,
            height: 100,
            vx: 0,
            vy: 0,
            speed: 2,
            jumping: false,
            hp: 100,
            projectiles: [],
            facing: 'left' // 캐릭터의 방향 ('left' 또는 'right')
        };

        // 적 설정
        let enemies = [];

        function initializeEnemies() {
            enemies = [
                {
                    type: 'wizard',
                    x: 100,
                    y: canvas.height - groundHeight - 48,
                    width: 32,
                    height: 48,
                    hp: 50,
                    attackCooldown: 0,
                    projectiles: [],
                    vx: 1,
                    vy: 0,
                    speed: 1,
                    facing: 'right'
                },
                {
                    type: 'archer',
                    x: 200,
                    y: canvas.height - groundHeight - 48,
                    width: 32,
                    height: 45,
                    hp: 50,
                    attackCooldown: 0,
                    projectiles: [],
                    vx: 1,
                    vy: 0,
                    speed: 1.5,
                    facing: 'right'
                },
                {
                    type: 'warrior',
                    x: 300,
                    y: canvas.height - groundHeight - 48,
                    width: 32,
                    height: 45,
                    hp: 100,
                    attackCooldown: 0,
                    projectiles: [],
                    vx: 1,
                    vy: 0,
                    speed: 1,
                    facing: 'right'
                }
            ];
        }

        initializeEnemies();

        // 키 입력 처리
        const keys = {};

        document.addEventListener('keydown', function(e) {
            keys[e.key] = true;
        });

        document.addEventListener('keyup', function(e) {
            keys[e.key] = false;
        });

        let flameCooldown = 0;

        function updatePlayer() {
            // 좌우 이동
            if (keys['ArrowLeft']) {
                player.vx = -player.speed;
                player.facing = 'left';
            } else if (keys['ArrowRight']) {
                player.vx = player.speed;
                player.facing = 'right';
            } else {
                player.vx = 0;
            }

            // 점프
            if (keys['ArrowUp'] && !player.jumping) {
                player.vy = -10;
                player.jumping = true;
            }

            // 화염 발사
            if (keys[' ']) { // 스페이스바는 ' '로 인식됩니다.
                shootFlame();
            }

            // 중력 적용
            player.vy += 0.5;

            // 위치 업데이트
            player.x += player.vx;
            player.y += player.vy;

            // 바닥 충돌
            if (player.y + player.height >= canvas.height - groundHeight) {
                player.y = canvas.height - groundHeight - player.height;
                player.vy = 0;
                player.jumping = false;
            }

            // 경계 체크
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

            // 쿨다운 감소
            if (flameCooldown > 0) {
                flameCooldown--;
            }
        }

        function shootFlame() {
            if (flameCooldown <= 0) {
                const speed = 5;
                const direction = player.facing === 'right' ? 1 : -1;

                player.projectiles.push({
                    x: player.x + player.width / 100,
                    y: player.y + player.height / 3,
                    vx: speed * direction,
                    vy: 0,
                    width: 35,
                    height: 35,
                    color: 'orange'
                });
                flameCooldown = 30; // 쿨다운 프레임 수
            }
        }

        function updateEnemies() {
            enemies.forEach(function(enemy) {
                // 플레이어와의 거리 계산
                let dx = player.x - enemy.x;

                // 적 이동 AI
                if (dx > 0) {
                    enemy.vx = enemy.speed;
                    enemy.facing = 'right';
                } else {
                    enemy.vx = -enemy.speed;
                    enemy.facing = 'left';
                }

                // 플레이어의 공격 회피
                if (Math.abs(dx) < 100 && Math.random() < 0.02) {
                    enemy.vy = -10; // 점프하여 회피
                }

                // 중력 적용
                enemy.vy += 0.5;

                // 위치 업데이트
                enemy.x += enemy.vx;
                enemy.y += enemy.vy;

                // 바닥 충돌
                if (enemy.y + enemy.height >= canvas.height - groundHeight) {
                    enemy.y = canvas.height - groundHeight - enemy.height;
                    enemy.vy = 0;
                }

                // 경계 체크
                if (enemy.x < 0) enemy.x = 0;
                if (enemy.x + enemy.width > canvas.width) enemy.x = canvas.width - enemy.width;

                // 공격 쿨다운 처리
                if (enemy.attackCooldown > 0) {
                    enemy.attackCooldown--;
                } else {
                    enemyAttack(enemy);
                    enemy.attackCooldown = 60;
                }

                // 적의 발사체 업데이트
                enemy.projectiles.forEach(function(proj) {
                    proj.x += proj.vx;
                    proj.y += proj.vy;

                    // 플레이어와의 충돌 체크
                    if (collision(proj, player)) {
                        player.hp -= 10;
                        enemy.projectiles.splice(enemy.projectiles.indexOf(proj), 1);
                    }
                });

                // 화면 밖으로 나간 발사체 제거
                enemy.projectiles = enemy.projectiles.filter(proj => proj.x < canvas.width && proj.x > 0 && proj.y > 0 && proj.y < canvas.height);
            });
        }

        function enemyAttack(enemy) {
            const dx = player.x - enemy.x;
            const dy = player.y - enemy.y;
            const magnitude = Math.sqrt(dx * dx + dy * dy);
            const directionX = (dx / magnitude);
            const directionY = (dy / magnitude);

            if (enemy.type === 'wizard') {
                // 마법구 발사
                enemy.projectiles.push({
                    x: enemy.x + enemy.width / 2,
                    y: enemy.y + enemy.height / 2,
                    vx: 3 * directionX,
                    vy: 3 * directionY,
                    width: 8,
                    height: 8,
                    color: 'blue'
                });
            } else if (enemy.type === 'archer') {
                // 화살 발사
                enemy.projectiles.push({
                    x: enemy.x + enemy.width / 2,
                    y: enemy.y + enemy.height / 2,
                    vx: 4 * directionX,
                    vy: 4 * directionY,
                    width: 8,
                    height: 2,
                    color: 'brown'
                });
            } else if (enemy.type === 'warrior') {
                // 검기 발사
                enemy.projectiles.push({
                    x: enemy.x + enemy.width / 2,
                    y: enemy.y + enemy.height / 2,
                    vx: 5 * directionX,
                    vy: 5 * directionY,
                    width: 10,
                    height: 4,
                    color: 'gray'
                });
            }
        }

        function updateProjectiles() {
            // 플레이어의 발사체 업데이트
            player.projectiles.forEach(function(proj) {
                proj.x += proj.vx;
                proj.y += proj.vy;

                // 적과의 충돌 체크
                enemies.forEach(function(enemy) {
                    if (collision(proj, enemy)) {
                        // 적에게 데미지
                        enemy.hp -= 20;
                        player.projectiles.splice(player.projectiles.indexOf(proj), 1);
                    }
                });
            });

            // 화면 밖으로 나간 발사체 제거
            player.projectiles = player.projectiles.filter(proj => proj.x > 0 && proj.x < canvas.width && proj.y > 0 && proj.y < canvas.height);
        }

        function collision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        // 도트 아트 그리기 함수
        function drawPixelArt(x, y, width, height, pixelData, flip = false) {
            const pixelSize = width / pixelData[0].length;
            for (let i = 0; i < pixelData.length; i++) {
                for (let j = 0; j < pixelData[i].length; j++) {
                    const pixelX = flip ? (x + (pixelData[i].length - 1 - j) * pixelSize) : (x + j * pixelSize);
                    if (pixelData[i][j]) {
                        ctx.fillStyle = pixelData[i][j];
                        ctx.fillRect(pixelX, y + i * pixelSize, pixelSize, pixelSize);
                    }
                }
            }
        }

        // 병아리 도트 아트 데이터
        const chickPixelData = [
            [null, null, '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', null, null,null],
            [null, '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', null,null],
            ['#000000', '#000000', '#000000', '#FFFF00', '#000000', '#000000', '#000000', '#FFFF00', null],
            ['#FFFFFF', '#FFFFFF', '#FFFFFF', '#FFFF00', '#FFFFFF', '#FFFFFF', '#FFFFFF', '#FFFF00', null],
            ['#FFFF00', '#FFFFFF', '#FFFFFF', '#FFFF00', '#FFFFFF', '#FFFFFF', '#FFFF00', '#FFFF00', null],
            ['#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', null],
            ['#FFFF00', '#FFFF00', '#FFAE00', '#FFAE00', '#FFAE00', '#FFFF00', '#FFFF00', '#FFFF00', null],
            ['#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFAE00', '#FFFF00', '#FFFF00', '#FFFF00', null],
            ['#FFFF00', '#FFFF00', '#FFAE00', '#FFAE00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', null],
            ['#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00','#FFFF00'],
            ['#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00',null],
            [null, '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', '#FFFF00', null,null],
            [null, null, '#000000', '#FFFF00', '#FFFF00', '#000000', null, null,null],
            [null, null, '#000000', null, null, '#000000', null, null,null]
        ];

        // 적 도트 아트 데이터
        const enemyPixelData = {
            'wizard': [
                [null, null, null, '#228B22', null, null, null],
                [null, null, '#228B22', '#228B22', '#228B22', null, null],
                [null, '#228B22', '#228B22', '#FFA128', '#000000', '#228B22', null],
                [null, null, '#228B22', '#FFA128', '#FFA128', null, null],
                [null, '#228B22', '#228B22', '#228B22', '#228B22', '#228B22', null],
                [null, '#228B22', '#228B22', '#228B22', '#228B22', '#FFA128', null],
                [null, '#FFA128', '#FFA128', '#228B22', '#228B22', '#FFA128', null],
                [null, null, '#228B22', '#228B22', '#228B22', null, null],
                [null, null, '#228B22', '#228B22', '#228B22', null, null],
                [null, null, '#000000', null, '#000000', null, null],
                [null, null, '#000000', null, '#000000', null, null]
            ],
            'archer': [
                [null, null, '#8B4513', '#8B4513', '#8B4513', null, null],
                [null, null, '#8B4513', '#8B4513', '#000000', null, null],
                [null, null, '#8B4513', '#FFA128', '#FFA128', null, null],
                [null, '#8B4513', '#8B4513', '#8B4513', '#8B4513', '#8B4513', null],
                [null, '#8B4513', '#8B4513', '#8B4513', '#8B4513', '#FFA128', null],
                [null, '#FFA128', '#FFA128', '#8B4513', '#8B4513', '#FFA128', null],
                [null, null, '#8B4513', '#8B4513', '#8B4513', null, null],
                [null, null, '#8B4513', '#8B4513', '#8B4513', null, null],
                [null, null, '#000000', null, '#000000', null, null],
                [null, null, '#000000', null, '#000000', null, null]
            ],
            'warrior': [
                [null, null, '#B22222', '#B22222', '#B22222', null, null],
                [null, null, '#B22222', '#B22222', '#000000', '#B22222', null],
                [null, null, '#B22222', '#B22222', '#FFA128', null, null],
                [null, '#B22222', '#B22222', '#B22222', '#B22222', '#B22222', null],
                [null, '#B22222', '#B22222', '#B22222', '#B22222', '#FFA128', null],
                [null, '#FFA128', '#FFA128', '#B22222', '#B22222', '#FFA128', null],
                [null, null, '#B22222', '#B22222', '#B22222', null, null],
                [null, null, '#B22222', '#B22222', '#B22222', null, null],
                [null, null, '#B22222', '#B22222', '#B22222', null, null],
                [null, null, '#000000', null, '#000000', null, null]
            ]
        };

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 땅 그리기
            ctx.fillStyle = 'green';
            ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);

            // 플레이어 그리기 (도트 아트)
            drawPixelArt(player.x, player.y, player.width, player.height, chickPixelData, player.facing === 'right');

            // 플레이어의 발사체 그리기
            player.projectiles.forEach(function(proj) {
                ctx.fillStyle = proj.color;
                ctx.fillRect(proj.x, proj.y, proj.width, proj.height);
            });

            // 적 그리기 (도트 아트)
            enemies.forEach(function(enemy) {
                drawPixelArt(enemy.x, enemy.y, enemy.width, enemy.height, enemyPixelData[enemy.type], enemy.facing === 'left');

                // 적의 발사체 그리기
                enemy.projectiles.forEach(function(proj) {
                    ctx.fillStyle = proj.color;
                    ctx.fillRect(proj.x, proj.y, proj.width, proj.height);
                });

                // 적의 HP 표시
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText(enemy.type + ' HP: ' + enemy.hp, enemy.x, enemy.y - 10);
            });

            // 플레이어 HP 표시
            ctx.fillStyle = 'white';
            ctx.font = '16px Arial';
            ctx.fillText('Player HP: ' + player.hp, 650, 20);
        }

        function gameLoop() {
            if (!gameOver) {
                updatePlayer();
                updateEnemies();
                updateProjectiles();
            }
            render();

            // 게임 승리 조건
            enemies = enemies.filter(enemy => enemy.hp > 0);

            if (enemies.length === 0 && !gameOver) {
                gameOver = true;
                showGameOver('승리했습니다!');
            }

            // 게임 패배 조건
            if (player.hp <= 0 && !gameOver) {
                gameOver = true;
                showGameOver('패배했습니다!');
            }

            if (!gameOver) {
                requestAnimationFrame(gameLoop);
            }
        }

        function showGameOver(message) {
            const gameOverScreen = document.getElementById('gameOverScreen');
            const gameOverMessage = document.getElementById('gameOverMessage');
            gameOverMessage.innerText = message;
            gameOverScreen.style.display = 'block';
        }

        document.getElementById('playAgainButton').addEventListener('click', function() {
            resetGame();
        });

        function resetGame() {
            // 게임 상태 초기화
            player.x = 700;
            player.y = canvas.height - groundHeight - player.height;
            player.hp = 100;
            player.projectiles = [];
            player.vx = 0;
            player.vy = 0;
            player.jumping = false;
            player.facing = 'left';

            initializeEnemies();

            flameCooldown = 0;
            gameOver = false;

            // 게임 오버 화면 숨기기
            document.getElementById('gameOverScreen').style.display = 'none';

            // 게임 루프 재시작
            requestAnimationFrame(gameLoop);
        }

        // 게임 시작
        gameLoop();
    </script>
</body>
</html>
